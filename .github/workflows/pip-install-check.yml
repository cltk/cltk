name: Daily pip install check

on:
  schedule:
    # Daily at 08:00 UTC
    - cron: "0 8 * * *"
  # Allow manual runs
  workflow_dispatch:

# Restrict default GITHUB_TOKEN permissions (principle of least privilege)
permissions:
  contents: read

jobs:
  pypi-install:
    name: Install from PyPI (${{ matrix.os }}, py${{ matrix.python-version }})
    runs-on: ${{ matrix.os }}
    timeout-minutes: 15
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        python-version: ["3.13"]
    steps:
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Upgrade pip
        run: python -m pip install --upgrade pip

      - name: Install CLTK from PyPI
        run: python -m pip install cltk

      - name: Verify import and print version
        run: python -c "import cltk, sys; print('CLTK import OK:', cltk.__version__)"

      - name: Check installed dependencies
        run: python -m pip check

  pypi-install-extras:
    name: Install PyPI with extra [${{ matrix.extra }}] (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    timeout-minutes: 20
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        extra: [openai, stanza, ollama, mistral]
    steps:
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - name: Upgrade pip
        run: python -m pip install --upgrade pip

      # --- Special path: macOS + stanza ---
      - name: "macOS stanza: preinstall torch wheel (venv, wheel-only)"
        if: ${{ runner.os == 'macOS' && matrix.extra == 'stanza' }}
        run: |
          python -m venv .venv
          source .venv/bin/activate
          python -m pip install --upgrade pip
          python -m pip install -v --no-cache-dir --only-binary=:all: torch

      - name: "macOS stanza: install CLTK with extra (venv)"
        if: ${{ runner.os == 'macOS' && matrix.extra == 'stanza' }}
        run: |
          source .venv/bin/activate
          python -m pip install "cltk[${{ matrix.extra }}]"

      - name: "macOS stanza: verify import (venv)"
        if: ${{ runner.os == 'macOS' && matrix.extra == 'stanza' }}
        run: |
          source .venv/bin/activate
          python -c "import cltk; print('CLTK import with extra OK')"

      - name: "macOS stanza: pip check (venv)"
        if: ${{ runner.os == 'macOS' && matrix.extra == 'stanza' }}
        run: |
          source .venv/bin/activate
          python -m pip check

      # --- Default path: everything else ---
      - name: Install CLTK with extra
        if: ${{ !(runner.os == 'macOS' && matrix.extra == 'stanza') }}
        run: python -m pip install "cltk[${{ matrix.extra }}]"

      - name: Verify import
        if: ${{ !(runner.os == 'macOS' && matrix.extra == 'stanza') }}
        run: python -c "import cltk; print('CLTK import with extra OK')"

      - name: Check installed dependencies
        if: ${{ !(runner.os == 'macOS' && matrix.extra == 'stanza') }}
        run: python -m pip check
